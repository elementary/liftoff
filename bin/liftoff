#!/bin/bash
set -e

while getopts a:b:d: var; do
	case $var in
		a) arch="$OPTARG";;
		b) build_dir="$OPTARG";;
		d) distro="$OPTARG";;
# Sensitive values hardcoded by default for security
#		c) config="$OPTARG";;
#		k) keyring="$OPTARG";;
#		p) pbuilderrc="$OPTARG";;
#		s) proxy="$OPTARG";;
# Don't forget to add newly enabled flags to getopts above!
	esac
done

# Passed to pbuilderrc
export DIST="$distro"
export ARCH="$arch"

# Sensitive paths
config="/usr/lib/liftoff/liftoff.conf"
pbuilderrc="/usr/lib/liftoff/pbuilderrc"

source "$config"

# Determine base path and keyring
keyring="/usr/share/keyrings/debian-archive-keyring.gpg"
case "$distro" in
	testing)
		basetgz="/var/cache/liftoff/$testing_codename-${arch}-base.tgz"
		;;
	unstable)
		basetgz="/var/cache/liftoff/$unstable_codename-${arch}-base.tgz"
		;;
	stable)
		basetgz="/var/cache/liftoff/$stable_codename-${arch}-base.tgz"
		;;
	*)
		basetgz="/var/cache/liftoff/$distro-${arch}-base.tgz"
		keyring="/etc/apt/trusted.gpg"
		;;
esac

create_base() {
	echo "Creating pbuilder environment..."
	pbuilder create \
		--basetgz "$basetgz" \
		--configfile "$pbuilderrc" \
		--debootstrapopts --keyring="$keyring" \
		--http-proxy "$proxy"
}

build_package() {
	pdebuild \
		--buildresult "$build_dir" \
		--configfile "$pbuilderrc"
}

print_debug() {
	echo "Architecture:  $arch"
	echo "Base:          $basetgz"
	echo "Configuration: $config"
	echo "Distribution:  $distro"
	echo "Keyring:       $keyring"
	echo "pbuilderrc:    $pbuilderrc"
	echo "Proxy:         $proxy"
}
#print_debug

# Create environment if it doesn't exist
if ( ! [ -e "$basetgz" ] || [ "$(stat --format=%s "$basetgz")" -eq 0 ] ); then
	create_base
fi

build_package # Build
